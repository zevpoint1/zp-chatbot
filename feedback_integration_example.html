<!DOCTYPE html>
<html>
<head>
    <title>Zevpoint Chatbot - Feedback Integration Example</title>
    <style>
        .feedback-buttons {
            margin-top: 8px;
            display: flex;
            gap: 8px;
            font-size: 12px;
        }

        .feedback-btn {
            padding: 4px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .feedback-btn:hover {
            background: #f5f5f5;
        }

        .feedback-btn.good:hover {
            background: #d4edda;
            border-color: #28a745;
            color: #28a745;
        }

        .feedback-btn.bad:hover {
            background: #f8d7da;
            border-color: #dc3545;
            color: #dc3545;
        }

        .feedback-btn.selected {
            font-weight: bold;
        }

        .feedback-btn.good.selected {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }

        .feedback-btn.bad.selected {
            background: #dc3545;
            border-color: #dc3545;
            color: white;
        }

        .feedback-note {
            margin-top: 8px;
            display: none;
        }

        .feedback-note.show {
            display: block;
        }

        .feedback-note textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .feedback-note select {
            width: 100%;
            padding: 6px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .message {
            margin: 10px 0;
            padding: 12px;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .message.bot {
            background: #e3f2fd;
        }
    </style>
</head>
<body>
    <h2>Chatbot with Feedback Integration</h2>

    <div id="chat-container">
        <!-- Example bot message -->
        <div class="message bot">
            <div class="bot-response">
                The Zevpoint Aveo Pro (Rs. 22,999) is a great choice for your Tata Nexon EV. It offers smart features like app control and scheduling for convenient charging.
            </div>

            <!-- Feedback buttons -->
            <div class="feedback-buttons" data-message-id="msg_001">
                <button class="feedback-btn good" onclick="handleFeedback('msg_001', 'good', this)">üëç Helpful</button>
                <button class="feedback-btn bad" onclick="handleFeedback('msg_001', 'bad', this)">üëé Not Helpful</button>
            </div>

            <!-- Feedback detail form (shown when "Not Helpful" is clicked) -->
            <div class="feedback-note" id="feedback-note-msg_001">
                <select id="issue-type-msg_001">
                    <option value="">What went wrong?</option>
                    <option value="irrelevant">Response not relevant</option>
                    <option value="wrong_info">Wrong information</option>
                    <option value="markdown">Formatting issues (stars/markdown)</option>
                    <option value="language">Wrong language</option>
                    <option value="missing_context">Didn't use documentation</option>
                    <option value="other">Other</option>
                </select>
                <textarea id="notes-msg_001" placeholder="Additional feedback (optional)" rows="2"></textarea>
                <button onclick="submitDetailedFeedback('msg_001')">Submit Feedback</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const FEEDBACK_API_URL = "https://zp-chatbot-v2.azurewebsites.net/api/feedback";

        // Store conversation context
        let currentUserId = "user_" + Math.random().toString(36).substr(2, 9);
        let currentSessionId = "session_" + Date.now();
        let messageContext = {}; // Store question/response pairs

        function handleFeedback(messageId, rating, buttonElement) {
            // Visual feedback
            const container = buttonElement.closest('.feedback-buttons');
            const allButtons = container.querySelectorAll('.feedback-btn');
            allButtons.forEach(btn => btn.classList.remove('selected'));
            buttonElement.classList.add('selected');

            // Show detailed feedback form for bad ratings
            const noteDiv = document.getElementById(`feedback-note-${messageId}`);
            if (rating === 'bad') {
                noteDiv.classList.add('show');
            } else {
                noteDiv.classList.remove('show');
                // Submit good feedback immediately
                submitFeedback(messageId, rating, '', '');
            }
        }

        function submitDetailedFeedback(messageId) {
            const issueType = document.getElementById(`issue-type-${messageId}`).value;
            const notes = document.getElementById(`notes-${messageId}`).value;

            submitFeedback(messageId, 'bad', issueType, notes);

            // Hide the form
            document.getElementById(`feedback-note-${messageId}`).classList.remove('show');
        }

        async function submitFeedback(messageId, rating, issueType, notes) {
            // Get the context for this message
            const context = messageContext[messageId] || {
                question: "Unknown question",
                response: "Unknown response"
            };

            const payload = {
                user_id: currentUserId,
                session_id: currentSessionId,
                message_id: messageId,
                user_question: context.question,
                bot_response: context.response,
                rating: rating,
                issue_type: issueType,
                notes: notes
            };

            try {
                const response = await fetch(FEEDBACK_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    console.log('Feedback submitted successfully');
                    // Optional: Show success message to user
                } else {
                    console.error('Failed to submit feedback:', await response.text());
                }
            } catch (error) {
                console.error('Error submitting feedback:', error);
            }
        }

        // Example: When you receive a bot message, store its context
        function addBotMessage(question, response, messageId) {
            messageContext[messageId] = {
                question: question,
                response: response
            };

            // Add message to DOM with feedback buttons...
            // (Your existing code for displaying messages)
        }

        // Example usage:
        // When user asks "What is the price?" and bot responds...
        addBotMessage(
            "What is the price?",
            "The Zevpoint Aveo Pro (Rs. 22,999) is a great choice...",
            "msg_001"
        );
    </script>
</body>
</html>
