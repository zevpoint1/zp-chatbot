<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Zevpoint Chatbot</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f1f1f1;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #chat-container {
            width: 420px;
            height: 620px;
            background: white;
            border-radius: 14px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #chat-header {
            background: #4a90e2;
            padding: 14px;
            color: white;
            font-size: 17px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #new-chat {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        #messages {
            flex: 1;
            padding: 14px;
            overflow-y: auto;
            background: #fafafa;
        }

        .message {
            margin-bottom: 10px;
            max-width: 78%;
            padding: 10px 12px;
            border-radius: 14px;
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .user {
            background: #dcf8c6;
            margin-left: auto;
            text-align: right;
        }

        .bot {
            background: #e6e6e6;
            margin-right: auto;
        }

        #typing {
            padding: 6px 14px;
            font-size: 12px;
            color: gray;
            display: none;
        }

        #status {
            padding: 6px 14px;
            font-size: 12px;
            color: #b33;
            display: none;
            background: #fff6f6;
            border-top: 1px solid #ffdede;
        }

        #input-area {
            display: flex;
            padding: 10px;
            border-top: 1px solid #eee;
            background: #fff;
        }

        #input-box {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
            font-size: 14px;
        }

        #send-btn {
            padding: 10px 14px;
            margin-left: 8px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
        }

        #send-btn:disabled {
            background: #a0c4f0;
            cursor: not-allowed;
        }
    </style>
</head>

<body>

<div id="chat-container">
    <div id="chat-header">
        <span>Zevpoint Advisor</span>
        <button id="new-chat">New Chat</button>
    </div>

    <div id="messages"></div>
    <div id="typing">Zevpoint Advisor is typing…</div>
    <div id="status"></div>

    <div id="input-area">
        <input type="text" id="input-box" placeholder="Type your message…" />
        <button id="send-btn">Send</button>
    </div>
</div>

<script>
/* ----------------------------------
   CONFIG
---------------------------------- */

const apiUrl = "https://zp-chatbot-v2-ewapbch4bmcgh6eu.southindia-01.azurewebsites.net/api/HttpTrigger";

/* ----------------------------------
   USER & SESSION HANDLING
---------------------------------- */

// Persistent user (same customer)
let userId = localStorage.getItem("chat_user_id");
if (!userId) {
    userId = crypto.randomUUID();
    localStorage.setItem("chat_user_id", userId);
}

// Per-tab session (new chat)
let sessionId = crypto.randomUUID();

/* ----------------------------------
   DOM ELEMENTS
---------------------------------- */

const messagesDiv = document.getElementById("messages");
const inputBox = document.getElementById("input-box");
const sendBtn = document.getElementById("send-btn");
const typingIndicator = document.getElementById("typing");
const statusDiv = document.getElementById("status");
const newChatBtn = document.getElementById("new-chat");

/* ----------------------------------
   HELPERS
---------------------------------- */

function addMessage(content, role) {
    const div = document.createElement("div");
    div.className = "message " + role;
    div.innerText = content;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function showStatus(msg) {
    if (!msg) {
        statusDiv.style.display = "none";
        statusDiv.innerText = "";
        return;
    }
    statusDiv.style.display = "block";
    statusDiv.innerText = msg;
}

function setLoading(isLoading) {
    typingIndicator.style.display = isLoading ? "block" : "none";
    sendBtn.disabled = isLoading;
    inputBox.disabled = isLoading;
}

/* ----------------------------------
   SEND MESSAGE
---------------------------------- */

async function sendMessage() {
    const userMessage = inputBox.value.trim();
    if (!userMessage) return;

    // Clear delayed nudge timer since user is active
    if (window.delayedNudgeTimer) {
        clearTimeout(window.delayedNudgeTimer);
        window.delayedNudgeTimer = null;
    }

    addMessage(userMessage, "user");
    inputBox.value = "";
    showStatus("");
    setLoading(true);

    try {
        const response = await fetch(apiUrl, {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "Access-Control-Allow-Origin": "*"
            },
            mode: "cors",
            body: JSON.stringify({
                message: userMessage,
                user_id: userId,
                session_id: sessionId
            })
        });

        const data = await response.json();
        setLoading(false);

        if (!response.ok) {
            addMessage(`⚠️ ${data.error || "Server error"}`, "bot");
            showStatus(`Server error (${response.status})`);
            return;
        }

        addMessage(data.response || "⚠️ No response", "bot");

        // Handle nudge (follow-up message) after a pause
        if (data.nudge && data.nudge.trim()) {
            console.log("Nudge received:", data.nudge);
            setTimeout(() => {
                addMessage(data.nudge, "bot");
            }, 5000); // 5 second delay for natural conversation flow
        }

        // Handle delayed nudge (re-engagement after inactivity)
        if (data.delayed_nudge && data.delayed_nudge.trim()) {
            console.log("Delayed nudge received:", data.delayed_nudge);
            // Clear any existing delayed nudge timer
            if (window.delayedNudgeTimer) {
                clearTimeout(window.delayedNudgeTimer);
            }
            // Set timer for 60 seconds of inactivity
            window.delayedNudgeTimer = setTimeout(() => {
                addMessage(data.delayed_nudge, "bot");
                window.delayedNudgeTimer = null;
            }, 60000); // 60 second delay for re-engagement
        }

    } catch (err) {
        setLoading(false);
        addMessage("⚠️ Unable to connect to server", "bot");
        showStatus("Network error. Check console.");
        console.error(err);
    }
}

/* ----------------------------------
   EVENTS
---------------------------------- */

sendBtn.onclick = sendMessage;

inputBox.addEventListener("keypress", e => {
    if (e.key === "Enter") sendMessage();
});

newChatBtn.onclick = () => {
    sessionId = crypto.randomUUID();
    messagesDiv.innerHTML = "";
    showStatus("");
    showWelcomeMessage();
};

function showWelcomeMessage() {
    addMessage("Hi! Are you looking for an EV charger?", "bot");
}

// Show welcome message on page load
showWelcomeMessage();

/* ----------------------------------
   DEBUG (REMOVE IN PROD)
---------------------------------- */

console.info("user_id:", userId);
console.info("session_id:", sessionId);
</script>

</body>
</html>
